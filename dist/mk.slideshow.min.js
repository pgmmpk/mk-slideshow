/*! https://github.com/pgmmpk/mk-slideshow.git 30-12-2013 */
!function(a){"use strict";var b=a.module("mk.slideshow",[]);b.directive("mkSlides",["$rootScope",function(a){return{restrict:"E",scope:{showingTime:"@",autoPlay:"@",onExit:"&"},transclude:!0,replace:!0,template:'<div class="slides-container"><div class="slides" ng-transclude/><form class="controls controls-color" ng-class=\'{"ephemeral": !canPlay() || (hidden && playing)}\' ng-click="togglePlay()"><i class="fa fa-play fa-2x" ng-hide="playing"></i><i class="fa fa-pause fa-2x" ng-hide="!playing"></i></form><form class="left-pager controls-color" ng-class=\'{"ephemeral": !canPrev() || (hidden && playing)}\' ng-click="pause(); prev()"><i class="fa fa-chevron-left fa-2x"></i></form><form class="right-pager controls-color" ng-class=\'{"ephemeral": !canNext() || (hidden && playing)}\' ng-click="pause(); next()"><i class="fa fa-chevron-right fa-2x"></i></form><form class="closer controls-color" ng-class=\'{"ephemeral": canPlay() && hidden && playing}\' ng-click="pause(); exit()"><i class="fa fa-times fa-2x"></i></form></div>',controller:"MkSlideshowCtrl",link:function(b,c,d,e){var f=null;c.on("mousemove",function(a){a.target===f&&(e.registerActivity(),b.$apply()),f=a.target}).on("touchstart",function(){e.registerActivity(),b.$apply()}),b.$on("$destroy",function(){c.off("mousemove").off("touchstart")}),a.$watchCollection("[viewportSize.width, viewportSize.height]",function(){a.viewportSize&&a.viewportSize.height>0&&a.viewportSize.width>0&&c.css({width:a.viewportSize.width+"px",height:a.viewportSize.height+"px"})})}}}]),b.directive("mkViewportSize",["$document","$window","$rootScope",function(a,b,c){return function(b){function d(){var b=a[0].documentElement.clientWidth,d=a[0].documentElement.clientHeight;c.$apply(function(){c.viewportSize={width:b,height:d}})}$(function(){d()}),window.addEventListener("resize",d,!1),b.$on("$destroy",function(){window.removeEventListener("resize",d,!1)})}}]),b.directive("mkSlide",[function(){return{restrict:"E",require:"^mkSlides",replace:!0,scope:!0,template:'<div class="slide" ng-show="slide.showing"><div class="slide-not-ready" ng-hide="slide.ready"><i class="fa fa-spinner fa-spin fa-2x spinner"></i></div><div class="slide-ready" ng-show="slide.ready"><img></img></div</div',link:function(a,b,c,d){var e=b.find("img");c.$observe("url",function(){c.url&&!a.slide&&(a.slide=d.addSlide(e,c.url),a.slide.promise.then(function(c){var d=c.elm;a.$watch(function(){return b.parent().height()^b.parent().width()},function(){var a=b.parent().width(),c=b.parent().height(),e=d[0].naturalHeight,f=d[0].naturalWidth;a*e>c*f?(f=f*c/e,e=c):(e=e*a/f,f=a),d.attr("width",f+"px").attr("height",e+"px")})}))})}}}]),b.controller("MkSlideshowCtrl",["$scope","$timeout","$q",function(a,b,c){function d(){a.playing&&b(function(){a.playing&&a.canNext()?a.next():a.pause()},a.showingTime||3e3)}function e(){a.loading=!0,h.forEach(function(a){a.showing=!1});var b=h[i];b&&(b.showing=!0,b.promise.then(function(){a.loading=!1,d()},function(){console.log("slide failed to load",b),a.loading=!1,d()}))}function f(d,e){var f=c.defer(),g={elm:d,src:e,ready:!1,promise:f.promise};return g.load=function(c){g.elm[0].src?b(function(){c(g.error,g)}):(g.elm[0].src=g.src,g.elm[0].onload=function(){g.ready=!0,f.resolve(g),c(null,g),a.$apply()},g.elm[0].onerror=function(b){g.ready=!0,g.error=b,f.reject(b),c(b,g),a.$apply()})},g}function g(){if(!j&&!k){j=!0;var a=0;!function b(){var c=h[a++];return c?(c.load(b),void 0):(j=!1,void 0)}()}}var h=[],i=0;a.hidden=!1,a.playing=!1,a.autoPlay=a.autoPlay&&"false"!==a.autoPlay,a.autoPlay&&(a.playing=!0,a.hidden=!0,b(function(){e()})),a.play=function(){i>=h.length-1&&(i=0),a.playing=!0,n(),e()},a.canPlay=function(){return h.length>1},a.pause=function(){a.playing&&(a.playing=!1)},a.togglePlay=function(){a.playing?a.pause():a.play()},a.next=function(){a.canNext()&&(i+=1,e())},a.canNext=function(){return i<h.length-1},a.prev=function(){a.canPrev()&&(i-=1,e())},a.canPrev=function(){return i>0},a.exit=function(){a.pause(),a.onExit()},a.autoPlay||b(function(){n(),e()});var j=!1,k=!1;a.$on("$destroy",function(){k=!0}),this.addSlide=function(a,b){var c=f(a,b);return h.push(c),g(),c};var l=null,m=1e3,n=this.registerActivity=function(){a.hidden=!1,l&&b.cancel(l),l=b(function(){l=null,a.hidden=!0},m)}}])}(angular);