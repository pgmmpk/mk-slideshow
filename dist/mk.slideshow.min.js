/*! https://github.com/pgmmpk/mk-slideshow.git 08-01-2014 */
!function(a){"use strict";var b=a.module("mk.slideshow",["ngTouch"]);b.directive("mkSlides",["$rootScope",function(a){return{restrict:"E",scope:{showingTime:"@",autoPlay:"@",onExit:"&",startIndex:"@"},transclude:!0,replace:!0,template:'<div class="slides-container" mk-viewport-size ng-swipe-left="pause(); next()" ng-swipe-right="pause(); prev()"><div class="slide-bg"><i class="fa fa-spinner fa-spin fa-2x spinner" ng-show="loading"></i></div><div class="slides" ng-transclude/><form class="controls controls-color" ng-class=\'{"ephemeral": !canPlay() || (hidden && playing)}\' ng-click="togglePlay()"><i class="fa fa-2x" ng-class=\'{"fa-play": !playing, "fa-pause": playing}\'"></i></form><form class="left-pager controls-color" ng-class=\'{"ephemeral": !canPrev() || (hidden && playing)}\' ng-click="pause(); prev()"><i class="fa fa-chevron-left fa-2x"></i></form><form class="right-pager controls-color" ng-class=\'{"ephemeral": !canNext() || (hidden && playing)}\' ng-click="pause(); next()"><i class="fa fa-chevron-right fa-2x"></i></form><form class="closer controls-color" ng-class=\'{"ephemeral": canPlay() && hidden && playing}\' ng-click="pause(); exit()"><i class="fa fa-times fa-2x"></i></form></div>',controller:"MkSlideshowCtrl",link:function(b,c,d,e){var f=null;c.on("mousemove",function(a){a.target===f&&(e.registerActivity(),b.$apply()),f=a.target}).on("touchstart",function(){e.registerActivity(),b.$apply()}),b.$on("$destroy",function(){c.off("mousemove").off("touchstart")}),a.$watchCollection("[viewportSize.width, viewportSize.height]",function(){a.viewportSize&&a.viewportSize.height>0&&a.viewportSize.width>0&&c.css({width:a.viewportSize.width+"px",height:a.viewportSize.height+"px"})})}}}]),b.directive("mkViewportSize",["$document","$window","$rootScope",function(a,b,c){return function(b){function d(){var b=a[0].documentElement.clientWidth,c=a[0].documentElement.clientHeight;return{width:b,height:c}}function e(){c.$apply(function(){c.viewportSize=d()})}$(function(){c.viewportSize=d()}),window.addEventListener("resize",e,!1),b.$on("$destroy",function(){window.removeEventListener("resize",e,!1)})}}]),b.directive("mkSlide",[function(){return{restrict:"E",require:"^mkSlides",replace:!0,scope:!0,template:'<div class="slide" ng-class=\'{"slide-before": slide.index < currentIndex(), "slide-after": slide.index > currentIndex()}\'><div class="slide-ready" ng-show="slide.ready"><img></img></div</div',link:function(a,b,c,d){var e=b.find("img");a.currentIndex=function(){return d.currentIndex()},c.$observe("url",function(){c.url&&!a.slide&&(a.slide=d.addSlide(e,c.url),a.slide.promise.then(function(c){var d=c.elm;a.$watch(function(){return b.parent().height()^b.parent().width()},function(){var a=b.parent().width(),c=b.parent().height(),e=d[0].naturalHeight,f=d[0].naturalWidth;a*e>c*f?(f=f*c/e,e=c):(e=e*a/f,f=a),d.attr("width",f+"px").attr("height",e+"px")})}))})}}}]),b.controller("MkSlideshowCtrl",["$scope","$timeout","$q",function(a,b,c){function d(){a.playing&&b(function(){a.playing&&a.canNext()?a.next():a.pause()},a.showingTime||3e3)}function e(){a.loading=!0;var b=h[i];b&&b.promise.finally(function(){a.loading=!1,d()})}function f(b,d){var e=c.defer(),f={elm:b,src:d,ready:!1,promise:e.promise};return f.load=function(){f.elm[0].src=f.src,f.elm[0].onload=function(){f.ready=!0,e.resolve(f),a.$apply()},f.elm[0].onerror=function(b){f.ready=!0,f.error=b,e.reject(b),a.$apply()}},f}function g(){var a=c.defer(),b=a.promise;h.forEach(function(a){b.finally(function(){j||a.load()}),b=a.promise}),a.resolve()}var h=[],i=+(a.startIndex||0);this.currentIndex=function(){return i},a.hidden=!1,a.playing=!1,a.autoPlay=a.autoPlay&&"false"!==a.autoPlay,a.autoPlay&&(a.playing=!0,a.hidden=!0,b(function(){e()})),a.play=function(){i>=h.length-1&&(i=0),a.playing=!0,m(),e()},a.canPlay=function(){return h.length>1},a.pause=function(){a.playing&&(a.playing=!1)},a.togglePlay=function(){a.playing?a.pause():a.play()},a.next=function(){a.canNext()&&(i+=1,e())},a.canNext=function(){return i<h.length-1},a.prev=function(){a.canPrev()&&(i-=1,e())},a.canPrev=function(){return i>0},a.exit=function(){a.pause(),a.onExit()},a.autoPlay||b(function(){m(),e()});var j=!1;a.$on("$destroy",function(){j=!0}),this.addSlide=function(a,c){var d=f(a,c);return d.index=h.length,h.push(d),1===h.length&&b(g),d};var k=null,l=1e3,m=this.registerActivity=function(){a.hidden=!1,k&&b.cancel(k),k=b(function(){k=null,a.hidden=!0},l)}}])}(angular);